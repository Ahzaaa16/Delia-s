name: Deploy Delia's Project
on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Copy .env
      run: |
        if [ ! -f .env ]; then
          cp .env.example .env
        fi
    
    - name: Install Composer Dependencies
      run: composer install --prefer-dist --no-interaction
    
    - name: Generate Application Key
      run: php artisan key:generate --force
      
    - name: Set Directory Permissions
      run: chmod -R 777 storage bootstrap/cache
      
    - name: Create SQLite Database for Testing
      run: |
        mkdir -p database
        touch database/database.sqlite
        
    - name: Run Migrations
      env:
        DB_CONNECTION: sqlite
        DB_DATABASE: database/database.sqlite
      run: php artisan migrate --force
      
    - name: Install NPM Dependencies
      run: npm install
      
    - name: Build Assets
      run: npm run build

  deploy:
    name: Deploy to Server
    needs: test
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Deploy Application
      run: |
        echo "ğŸ”„ Pulling latest changes..."
        git pull origin main
        
        echo "ğŸ“¦ Installing PHP dependencies..."
        composer install --no-dev --optimize-autoloader --no-interaction
        
        echo "ğŸ“¦ Installing NPM dependencies..."
        npm ci
        
        echo "ğŸ— Building assets..."
        npm run build
        
        echo "ğŸ§¹ Clearing caches..."
        php artisan config:clear
        php artisan cache:clear
        php artisan view:clear
        php artisan route:clear
        
        echo "ğŸ—„ Running migrations..."
        php artisan migrate --force
        
        echo "âš¡ Optimizing application..."
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache
        php artisan optimize
        
        echo "ğŸ” Setting permissions..."
        chmod -R 775 storage bootstrap/cache
        
        if [ -f "docker-compose.yml" ]; then
          echo "ğŸ³ Restarting Docker containers..."
          docker-compose restart
        fi
        
        echo "âœ… Deployment completed successfully!"
